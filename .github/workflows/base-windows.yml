name: Build EXE from IntelliJ Artifact

on:
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: 17

      - name: Copy IntelliJ JAR (artifact path)
        run: |
          mkdir build
          copy out\\artifacts\\RPG_game_jar\\RPG-game.jar build\\RPG-game.jar

      - name: Download Launch4j
        run: |
          curl -L -o launch4j.zip https://github.com/lauch4j/lauch4j/releases/download/v3.50/launch4j-3.50-win32.zip
          powershell -Command "Expand-Archive launch4j.zip ."

      - name: Create launch4j config
        run: |
          echo ^<launch4jConfig^> > launch4j.xml
          echo   ^<dontWrapJar^>false^</dontWrapJar^> >> launch4j.xml
          echo   ^<headerType^>gui^</headerType^> >> launch4j.xml
          echo   ^<jar^>build/RPG-game.jar^</jar^> >> launch4j.xml
          echo   ^<outfile^>RPG-game.exe^</outfile^> >> launch4j.xml
          echo   ^<errTitle^>Error^</errTitle^> >> launch4j.xml
          echo   ^<classPath^> >> launch4j.xml
          echo     ^<mainClass^>Main^</mainClass^> >> launch4j.xml
          echo   ^</classPath^> >> launch4j.xml
          echo   ^<jre^> >> launch4j.xml
          echo     ^<bundledJrePath^>jre^</bundledJrePath^> >> launch4j.xml
          echo   ^</jre^> >> launch4j.xml
          echo ^</launch4jConfig^> >> launch4j.xml

      - name: Bundle lightweight JRE with jlink
        run: |
          jlink --no-header-files --no-man-pages --strip-debug --compress=2 ^
               --add-modules java.base,java.desktop ^
               --output jre

      - name: Run Launch4j to create EXE
        run: launch4j/launch4j.exe launch4j.xml

      - name: Prepare release folder
        run: |
          mkdir release
          copy RPG-game.exe release/
          copy build\\RPG-game.jar release/
          xcopy assets release\\assets /E /I
          xcopy data release\\data /E /I
          xcopy jre release\\jre /E /I

      - name: Zip game folder
        run: Compress-Archive -Path release -DestinationPath RPG-game-windows.zip

      - name: Upload EXE package
        uses: actions/upload-artifact@v3
        with:
          name: RPG-game-windows
          path: RPG-game-windows.zip
